{% extends "base.html" %}

{% block title %}Ajustar Stock - {{ producto.nombre }} - Sistema de Inventario{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h4 class="mb-0">üìä Ajustar Stock</h4>
                <div>
                    <a href="{{ url_for('producto.ver', id_empresa=id_empresa, id_producto=producto.id_producto) }}" 
                       class="btn btn-outline-dark btn-sm me-2">
                        üëÅÔ∏è Ver Producto
                    </a>
                    <a href="{{ url_for('producto.listar', id_empresa=id_empresa) }}" 
                       class="btn btn-outline-dark btn-sm">
                        üì¶ Lista
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Informaci√≥n del producto -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title">{{ producto.nombre }}</h5>
                                <p class="card-text">
                                    <strong>ID:</strong> <code>{{ producto.id_producto }}</code><br>
                                    {% if producto.descripcion %}
                                    <strong>Descripci√≥n:</strong> {{ producto.descripcion }}<br>
                                    {% endif %}
                                    <strong>Precio:</strong> <span class="text-success">${{ "{:,}".format(producto.precio) }}</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="display-6">
                                    {% if producto.stock <= 0 %}
                                        <span class="badge bg-danger">{{ producto.stock }}</span>
                                    {% elif producto.stock <= 5 %}
                                        <span class="badge bg-warning text-dark">{{ producto.stock }}</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ producto.stock }}</span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">Stock Actual</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario de ajuste -->
                <form method="POST">
                    <div class="mb-3">
                        <label for="nuevo_stock" class="form-label">
                            <strong>Nuevo Stock</strong>
                        </label>
                        <div class="input-group input-group-lg">
                            <input type="number" 
                                   class="form-control" 
                                   id="nuevo_stock" 
                                   name="nuevo_stock" 
                                   value="{{ producto.stock }}" 
                                   min="0" 
                                   required
                                   oninput="calcularDiferencia()">
                            <span class="input-group-text">unidades</span>
                        </div>
                    </div>

                    <!-- Mostrar diferencia -->
                    <div id="diferencia" class="alert d-none mb-3" role="alert">
                        <div id="diferencia-content"></div>
                    </div>

                    <!-- Motivo del ajuste -->
                    <div class="mb-3">
                        <label for="motivo" class="form-label">
                            <strong>Motivo del Ajuste</strong> <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="motivo" 
                               name="motivo" 
                               placeholder="Ej: Inventario f√≠sico, producto da√±ado, venta sin registrar, etc." 
                               required 
                               maxlength="255">
                        <div class="form-text">
                            Especifica la raz√≥n del cambio para el historial de movimientos
                        </div>
                    </div>

                    <!-- Opciones r√°pidas de motivos -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Motivos Comunes:</strong></label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setMotivo('Inventario f√≠sico')">
                                üìã Inventario f√≠sico
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setMotivo('Producto da√±ado')">
                                üíî Producto da√±ado
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setMotivo('Producto vencido')">
                                ‚è∞ Producto vencido
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setMotivo('Correcci√≥n de error')">
                                üîß Correcci√≥n de error
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setMotivo('Nueva compra')">
                                üì¶ Nueva compra
                            </button>
                        </div>
                    </div>

                    <!-- Informaci√≥n importante -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">‚ÑπÔ∏è Informaci√≥n:</h6>
                        <ul class="mb-0 small">
                            <li>Este ajuste se registrar√° en el <strong>historial de movimientos</strong></li>
                            <li>Si aumentas el stock, se registra como <span class="badge bg-success">ENTRADA</span></li>
                            <li>Si disminuyes el stock, se registra como <span class="badge bg-danger">SALIDA</span></li>
                            <li>El motivo ayuda a mantener un control adecuado del inventario</li>
                        </ul>
                    </div>

                    <!-- Vista previa del cambio -->
                    <div class="card border-primary mb-3">
                        <div class="card-body">
                            <h6 class="card-title">üìä Vista Previa del Cambio</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="fs-4 text-muted">{{ producto.stock }}</div>
                                    <small>Stock Actual</small>
                                </div>
                                <div class="col-4">
                                    <div class="fs-2">‚Üí</div>
                                    <small>Cambio</small>
                                </div>
                                <div class="col-4">
                                    <div id="nuevo-stock-preview" class="fs-4 text-primary">{{ producto.stock }}</div>
                                    <small>Nuevo Stock</small>
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <strong>Nuevo Valor Total en Inventario:</strong>
                                <div id="valor-total-preview" class="fs-5 text-success">
                                    ${{ "{:,}".format(producto.precio * producto.stock) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('producto.ver', id_empresa=id_empresa, id_producto=producto.id_producto) }}" 
                           class="btn btn-secondary">
                            ‚Üê Cancelar
                        </a>
                        <button type="submit" class="btn btn-warning">
                            üìä Ajustar Stock
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Historial reciente -->
        {% if producto.movimientos %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">üìà √öltimos Movimientos</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Cantidad</th>
                                <th>Usuario</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movimiento in producto.movimientos[-5:] %}
                            <tr>
                                <td>{{ movimiento.fecha_hora }}</td>
                                <td>
                                    {% if movimiento.tipo_movimiento == 'ENTRADA' %}
                                        <span class="badge bg-success">‚¨ÜÔ∏è Entrada</span>
                                    {% else %}
                                        <span class="badge bg-danger">‚¨áÔ∏è Salida</span>
                                    {% endif %}
                                </td>
                                <td>{{ movimiento.cantidad }}</td>
                                <td>{{ movimiento.usuario.nom_usuario if movimiento.usuario else 'Sistema' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
const stockActual = {{ producto.stock }};
const precioUnitario = {{ producto.precio }};

function calcularDiferencia() {
    const nuevoStock = parseInt(document.getElementById('nuevo_stock').value) || 0;
    const diferencia = nuevoStock - stockActual;
    const diferenciaDiv = document.getElementById('diferencia');
    const diferenciaContent = document.getElementById('diferencia-content');
    const nuevoStockPreview = document.getElementById('nuevo-stock-preview');
    const valorTotalPreview = document.getElementById('valor-total-preview');

    // Actualizar vista previa
    nuevoStockPreview.textContent = nuevoStock;
    valorTotalPreview.textContent = `$${(precioUnitario * nuevoStock).toLocaleString()}`;

    if (diferencia === 0) {
        diferenciaDiv.classList.add('d-none');
    } else {
        diferenciaDiv.classList.remove('d-none');
        
        if (diferencia > 0) {
            diferenciaDiv.className = 'alert alert-success mb-3';
            diferenciaContent.innerHTML = `
                <strong>‚¨ÜÔ∏è ENTRADA de ${diferencia} unidades</strong><br>
                <small>Se agregar√° stock al inventario</small>
            `;
        } else {
            diferenciaDiv.className = 'alert alert-warning mb-3';
            diferenciaContent.innerHTML = `
                <strong>‚¨áÔ∏è SALIDA de ${Math.abs(diferencia)} unidades</strong><br>
                <small>Se reducir√° stock del inventario</small>
            `;
        }
    }
}

function setMotivo(motivo) {
    document.getElementById('motivo').value = motivo;
}

// Inicializar c√°lculo
document.addEventListener('DOMContentLoaded', function() {
    calcularDiferencia();
});
</script>
{% endblock %}